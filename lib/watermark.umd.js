(function(n,h){typeof exports=="object"&&typeof module<"u"?module.exports=h():typeof define=="function"&&define.amd?define(h):(n=typeof globalThis<"u"?globalThis:n||self,n.Watermark=h())})(this,function(){"use strict";var N=Object.defineProperty;var P=(n,h,p)=>h in n?N(n,h,{enumerable:!0,configurable:!0,writable:!0,value:p}):n[h]=p;var u=(n,h,p)=>P(n,typeof h!="symbol"?h+"":h,p);const n={zIndex:999999,rotate:-20,gap:[24,24],offset:[0,0],textAlign:"center",fontStyle:{fontSize:"16px",color:"rgba(0, 0, 0, 0.15)",fontFamily:"sans-serif",fontWeight:"normal"}};function h(f,e){if(!f)return e;if(Object.prototype.toString.call(f)==="[object Number]")return f;const t=parseFloat(f);return isNaN(t)?e:t}function p(f){const{image:e,gap:t,rotate:i}=f,c=document.createElement("canvas"),o=c.getContext("2d"),l=({width:d,height:a})=>{const r=window.devicePixelRatio,s=t[0]+d,m=t[1]+a;c.setAttribute("width",`${s*r}px`),c.setAttribute("height",`${m*r}px`),c.style.width=`${s}px`,c.style.height=`${m}px`,o.translate(s*r/2,m*r/2),o.scale(r,r);const x=Math.PI*i/180;o.rotate(x)},g=(d,a,r)=>{let s=0,m=0;const x=[];for(const k of a){const{width:v,fontBoundingBoxAscent:E,fontBoundingBoxDescent:$}=d.measureText(k),b=E+$;s+=b,m<v&&(m=v),x.push({width:v,height:b})}return{contentSizeInfoList:x,contentWidth:m,contentHeight:s,width:Math.ceil(Math.abs(Math.sin(r)*s)+Math.abs(Math.cos(r)*m)),height:Math.ceil(Math.abs(Math.sin(r)*m)+Math.abs(Math.cos(r)*s))}},w=()=>{const{content:d,rotate:a,fontStyle:r,textAlign:s}=f,{fontFamily:m,fontSize:x,fontWeight:k,color:v}=r,E=parseInt(x)||16,$=Math.PI*a/180;o.font=`${k} ${E}px ${m}`;const b=g(o,d,$),W=f.width||b.width,I=f.height||b.height;return l({width:W,height:I}),o.fillStyle=v,o.font=`${k} ${E}px ${m}`,o.textBaseline="top",d.forEach((C,z)=>{const S=b.contentSizeInfoList[z],B=s==="center"?-S.width/2:12,A=-(f.height||b.contentHeight)/2+S.height*z;o.fillText(C,B,A,f.width||b.contentWidth)}),Promise.resolve({watermarkBase64Url:c.toDataURL(),width:W,height:I})};return e?new Promise(d=>{const a=new Image;a.crossOrigin="anonymous",a.referrerPolicy="no-referrer",a.onload=()=>{let{width:r,height:s}=f;return!r&&!s?(r=a.width,s=a.height):(!r||!s)&&(r?s=a.height/a.width*+r:r=a.width/a.height*+s),l({width:r,height:s}),o.drawImage(a,-r/2,-s/2,r,s),d({watermarkBase64Url:c.toDataURL(),width:r,height:s})},a.onerror=()=>w(),a.src=e}):w()}class M{constructor(e){u(this,"mutationObserver",null);u(this,"options");u(this,"watermarkEl",null);u(this,"draw",async e=>{e&&(this.options=this.mergeOptions(e));const t=this.options;if(!t)return;const i=t.getContainer();if(!i)return;const{watermarkBase64Url:c,width:o,height:l}=await p(t);this.removeWatermarkEl(),this.appendWatermarkEl(i,this.buildWatermarkEl(c,o,l,t)),this.observe()});u(this,"destroy",()=>{var e;(e=this.mutationObserver)==null||e.disconnect(),this.removeWatermarkEl(),this.mutationObserver=null});u(this,"appendWatermarkEl",(e,t)=>{this.watermarkEl=t,e.append(t)});u(this,"removeWatermarkEl",()=>{var i,c;(i=this.mutationObserver)==null||i.disconnect();const e=this.watermarkEl,t=(c=this.options)==null?void 0:c.getContainer();e&&(t&&t.contains(e)?t.removeChild(e):e.remove())});u(this,"observe",()=>{var t;if(!this.mutationObserver){if(!this.watermarkEl)return;this.mutationObserver=new MutationObserver(i=>{i.some(o=>{let l=!1;return o.removedNodes.length&&(l=Array.from(o.removedNodes).some(g=>g===this.watermarkEl)),o.attributeName==="style"&&o.target===this.watermarkEl&&(l=!0),l})&&(this.removeWatermarkEl(),this.draw())})}const e=(t=this.options)==null?void 0:t.getContainer();!this.mutationObserver||!e||this.mutationObserver.observe(e,{subtree:!0,attributes:!0,childList:!0})});u(this,"mergeOptions",e=>{var c,o,l,g,w,y,d,a,r;const t=e||{},i={...t,getContainer:t.getContainer,rotate:t.rotate||n.rotate,width:h(t.width,void 0),height:h(t.height,void 0),textAlign:t.textAlign||"center",gap:[h((c=t==null?void 0:t.gap)==null?void 0:c[0],(o=n==null?void 0:n.gap)==null?void 0:o[0]),h((l=t==null?void 0:t.gap)==null?void 0:l[1],(g=n==null?void 0:n.gap)==null?void 0:g[1])],fontStyle:{...n.fontStyle,...t.fontStyle||{}},zIndex:t.zIndex||n.zIndex};return i.offset=[h((w=i==null?void 0:i.offset)==null?void 0:w[0],(y=n==null?void 0:n.offset)==null?void 0:y[0]),h(((d=i==null?void 0:i.offset)==null?void 0:d[1])||((a=i==null?void 0:i.offset)==null?void 0:a[0]),(r=n==null?void 0:n.offset)==null?void 0:r[1])],i});this.options=this.mergeOptions(e)}buildWatermarkEl(e,t,i,c){const{zIndex:o,gap:l,offset:g}=c,w=document.createElement("div");return w.setAttribute("style",`position: absolute;z-index: ${o};left: ${g[0]||0}px;top: ${g[1]||0}px;width: calc(100% - ${g[0]||0}px);height: calc(100% - ${g[1]||0}px);background-position: 0 0;background-repeat: repeat;background-size: ${l[0]+t}px ${l[1]+i}px;background-image: url(${e});pointer-events: none;`),w}}return M});
